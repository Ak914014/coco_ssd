<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const fs = require('fs');
const path = require('path');
const jpeg = require('jpeg-js');
const express = require("express");
const pureimage = require("pureimage");
const compression = require("compression");
const http = require("http");
const socketIo = require("socket.io");
const nodeFetch = require('node-fetch');
const cors = require('cors');

global.fetch = nodeFetch;

require('@tensorflow/tfjs-backend-cpu');
require('@tensorflow/tfjs-backend-webgl');
const tf = require('@tensorflow/tfjs-node');
const cocoSsd = require('@tensorflow-models/coco-ssd');

const app = express();
const server = http.createServer(app);
 

const io = socketIo(server, {
  cors: {
    origin: "http://localhost:3006", 
    methods: ["GET", "POST"],
    allowedHeaders: ["my-custom-header"],
    credentials: true,
  },
});

app.use(cors({
  origin: "http://localhost:3006",
  credentials: true,
}));

app.use(compression());

const PORT = process.env.PORT || 5000;

let scoreThreshold = 0.5;
let maxDetections = 20;
let model;

/**
 * Load and register font.
 * @async
 */
async function loadFont() {
    const font = pureimage.registerFont(path.join(__dirname, 'SourceSansPro-Regular.ttf'), 'Source Sans Pro');
    await font.load();
}
loadFont();

/**
 * Load COCO-SSD model.
 * @async
 */
async function loadModel() {
    model = await cocoSsd.load();
    console.log('Model ready');
}
console.log('Loading model...');
loadModel();


/**
 * Process image and get detections.
 * @param {Buffer} imageBuffer - The image buffer.
 * @returns {Promise&lt;object[]>} The detections object.
 */
async function reco(imageBuffer) {
    const img = tf.node.decodeImage(imageBuffer);
    const detections = await model.detect(img, maxDetections, scoreThreshold);
    tf.dispose(img);
    return detections;
}

/**
 * Socket.IO connection event.
 * @event connection
 * @param {Socket} socket - The Socket.IO socket instance.
 */
io.on('connection', (socket) => {
    console.log('New client connected');

    /**
     * Event for receiving image data.
     * @event image
     * @param {string} imageData - Base64 encoded image data.
     */
    socket.on('image', async (imageData) => {
        const imageBuffer = Buffer.from(imageData, 'base64');
        const predictions = await reco(imageBuffer);
        socket.emit('predictions', predictions);
    });

    /**
     * Event for client disconnection.
     * @event disconnect
     */
    socket.on('disconnect', () => {
        console.log('Client disconnected');
    });
});

/**
 * Start the server and listen on the specified port.
 */
server.listen(PORT, () => {
    console.log(`Server is running on http://localhost:${PORT}`);
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Events</h3><ul><li><a href="global.html#event:connection">connection</a></li><li><a href="global.html#event:disconnect">disconnect</a></li><li><a href="global.html#event:image">image</a></li></ul><h3>Global</h3><ul><li><a href="global.html#loadFont">loadFont</a></li><li><a href="global.html#loadModel">loadModel</a></li><li><a href="global.html#reco">reco</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.3</a> on Fri Jul 19 2024 14:58:25 GMT+0530 (India Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
